/* ===== Prioriza√≠ (novo layout) | app.js =====
   - Mant√©m a navega√ß√£o por m√≥dulos
   - Bot√£o "Gerar" no final do formul√°rio do m√≥dulo ativo
   - Integra com o Worker via endpoints /prioritize, /calmai, /briefai
*/

(() => {
  "use strict";

  // ========= CONFIG =========
  const WORKER_BASE_URL = "https://priorizai.felipelcas.workers.dev";

  const MIN_TASKS = 3;
  const MAX_TASKS = 10;

  const MODULE_ENDPOINTS = {
    priorizai: "/prioritize",
    calmai: "/calmai",
    briefai: "/briefai",
  };

  const MODULE_TITLES = {
    priorizai: "PriorizAI",
    calmai: "CalmAI",
    briefai: "BriefAI",
  };

  const MODULE_DESCRIPTIONS = {
    priorizai: "Organize e priorize tarefas com crit√©rios simples e objetivo.",
    calmai: "Reescreva mensagens para um tom mais calmo e assertivo.",
    briefai: "Resuma textos longos em um formato executivo e direto.",
  };

  const PROCESS_BUTTON_LABELS = {
    priorizai: "‚ú® Priorizar tarefas",
    calmai: "‚ú® Gerar vers√£o calma",
    briefai: "‚ú® Gerar resumo",
  };

  // ========= STATE =========
  let currentModule = "priorizai";
  let selectedMethod = "impact_effort";

  // ========= UTILS =========
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function safeTrim(s) {
    return String(s || "").trim();
  }

  function setText(id, value) {
    const el = $(id);
    if (el) el.textContent = value;
  }

  function getValue(id) {
    const el = $(id);
    return el ? el.value : "";
  }

  function scrollToResults() {
    const section = $("resultsSection");
    if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // ========= WORKER CALL =========
  async function callWorkerJson(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const raw = await res.text();
    let data = null;
    try {
      data = raw ? JSON.parse(raw) : null;
    } catch {
      // resposta n√£o JSON
    }

    if (!res.ok) {
      const status = res.status;
      const code = (data && (data.code || data.error_code)) || "";

      if (status === 429 || code === "RATE_LIMITED") {
        const limit = Number(data?.limit ?? 3);
        const resetAt = data?.resetAt;

        const msgReset = resetAt ? `Tente novamente em ${formatDateTimeBR(resetAt)}.` : "Tente novamente amanh√£.";
        const msg = `Limite di√°rio atingido. Voc√™ pode usar at√© ${limit} vezes por dia por IP. ${msgReset}`;

        const err = new Error(msg);
        err.code = "RATE_LIMITED";
        err.status = status;
        err.details = data;
        throw err;
      }

      const msg = (data && (data.message || data.error)) || raw || "Erro ao chamar o servi√ßo.";
      const err = new Error(msg);
      err.code = code || "WORKER_ERROR";
      err.status = status;
      err.details = data;
      throw err;
    }

    return data || {};
  }

  function updateProcessButtonLabel(module) {
    const btn = $("processBtn");
    if (!btn) return;
    btn.textContent = PROCESS_BUTTON_LABELS[module] || "‚ú® Gerar";
  }

  function moveProcessButtonToModule(module) {
    const btn = $("processBtn");
    if (!btn) return;
    const slot = document.querySelector(`.process-slot[data-module="${module}"]`);
    if (slot) slot.appendChild(btn);
    updateProcessButtonLabel(module);
  }

  // ========= UI: MODULE SWITCH =========
  function switchModule(module) {
    currentModule = module;

    document.querySelectorAll(".module-tab").forEach((t) => t.classList.remove("active"));
    document.querySelector(`.module-tab[data-module="${module}"]`)?.classList.add("active");

    document.querySelectorAll(".module-content").forEach((c) => c.classList.remove("active"));
    document.querySelector(`.module-content[data-module="${module}"]`)?.classList.add("active");

    const desc = $("moduleDescription");
    if (desc) desc.textContent = MODULE_DESCRIPTIONS[module] || "";

    const resultsSection = $("resultsSection");
    if (resultsSection) resultsSection.style.display = "none";

    moveProcessButtonToModule(module);
  }

  function initModuleTabs() {
    document.querySelectorAll(".module-tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const m = tab.dataset.module;
        if (!m) return;
        switchModule(m);
      });
    });
  }

  // ========= UI: METHOD =========
  function initMethodCards() {
    document.querySelectorAll(".method-card").forEach((card) => {
      card.addEventListener("click", () => {
        if (card.classList.contains("disabled")) return;

        document.querySelectorAll(".method-card").forEach((c) => c.classList.remove("active"));
        card.classList.add("active");

        const v = String(card.dataset.method || "").trim();
        selectedMethod = v === "impact_effort" ? "impact_effort" : "impact_effort";
      });
    });
  }

  // ========= TASK LIST =========
  function getTasksFromUI() {
    const rows = document.querySelectorAll(".task-row");
    const tasks = [];

    rows.forEach((row) => {
      const title = safeTrim(row.querySelector(".task-title")?.value || "");
      const context = safeTrim(row.querySelector(".task-context")?.value || "");
      const impact = safeTrim(row.querySelector(".task-impact")?.value || "");
      const effort = safeTrim(row.querySelector(".task-effort")?.value || "");

      if (title && context && impact && effort) {
        tasks.push({ title, context, impact, effort });
      }
    });

    return tasks;
  }

  function addTaskRow(initial = {}) {
    const container = $("taskList");
    if (!container) return;

    if (document.querySelectorAll(".task-row").length >= MAX_TASKS) {
      showError(`Voc√™ j√° atingiu o m√°ximo de ${MAX_TASKS} tarefas.`);
      return;
    }

    const div = document.createElement("div");
    div.className = "task-row";

    div.innerHTML = `
      <div class="row-head">
        <div class="row-title">Tarefa</div>
        <button type="button" class="icon-btn remove-task" title="Remover">‚úï</button>
      </div>

      <label class="field">
        <span class="label">T√≠tulo</span>
        <input class="task-title" placeholder="Ex.: Revisar funil de vendas" value="${escapeHtml(
          initial.title || ""
        )}" />
      </label>

      <label class="field">
        <span class="label">Contexto</span>
        <textarea class="task-context" rows="2" placeholder="Ex.: Q1, foco em convers√£o">${escapeHtml(
          initial.context || ""
        )}</textarea>
      </label>

      <div class="grid-2">
        <label class="field">
          <span class="label">Impacto</span>
          <input class="task-impact" placeholder="Ex.: Alto" value="${escapeHtml(initial.impact || "")}" />
        </label>
        <label class="field">
          <span class="label">Esfor√ßo</span>
          <input class="task-effort" placeholder="Ex.: M√©dio" value="${escapeHtml(initial.effort || "")}" />
        </label>
      </div>
    `;

    div.querySelector(".remove-task")?.addEventListener("click", () => {
      div.remove();
      updateTaskCount();
    });

    container.appendChild(div);
    updateTaskCount();
  }

  function updateTaskCount() {
    const count = document.querySelectorAll(".task-row").length;
    const el = $("taskCounter");
    if (el) el.textContent = `${count}/${MAX_TASKS}`;

    const addBtn = $("addTaskBtn");
    if (addBtn) addBtn.disabled = count >= MAX_TASKS;
  }

  function initTaskControls() {
    $("addTaskBtn")?.addEventListener("click", () => addTaskRow());
  }

  // ========= RESULTS RENDER =========
  function renderPrioritizeResult(data) {
    const section = $("resultsSection");
    const container = $("resultsContainer");
    if (!section || !container) return;

    section.style.display = "block";

    const ordered = Array.isArray(data.ordered_tasks) ? data.ordered_tasks : [];

    const orderRows = ordered
      .map(
        (t) => `
      <tr>
        <td style="color: var(--accent-cyan); font-weight: 700;">${escapeHtml(t.position)}</td>
        <td>${escapeHtml(t.task_title)}</td>
      </tr>`
      )
      .join("");

    const orderTableHTML = `
      <table class="order-table">
        <thead>
          <tr>
            <th style="width: 90px;">Ordem</th>
            <th>Tarefa</th>
          </tr>
        </thead>
        <tbody>
          ${orderRows || `<tr><td colspan="2" style="opacity:.7;">Sem itens retornados.</td></tr>`}
        </tbody>
      </table>
    `;

    container.innerHTML = `
      <div class="results-header">
        <div class="results-title">${escapeHtml(MODULE_TITLES.priorizai)}</div>
        <div class="results-subtitle">Resultado gerado com base nas tarefas informadas.</div>
      </div>

      <div class="results-card">
        ${orderTableHTML}
      </div>
    `;

    scrollToResults();
  }

  function renderCalmAIResult(data) {
    const section = $("resultsSection");
    const container = $("resultsContainer");
    if (!section || !container) return;

    section.style.display = "block";

    const text = safeTrim(data.rewritten_text || "");

    container.innerHTML = `
      <div class="results-header">
        <div class="results-title">${escapeHtml(MODULE_TITLES.calmai)}</div>
        <div class="results-subtitle">Mensagem reescrita em um tom mais calmo.</div>
      </div>

      <div class="results-card">
        <div class="result-text">${escapeHtml(text || "Sem texto retornado.")}</div>
        <div class="result-actions">
          <button type="button" class="btn" id="copyCalmBtn">Copiar</button>
        </div>
      </div>
    `;

    $("copyCalmBtn")?.addEventListener("click", () => {
      navigator.clipboard.writeText(text || "").catch(() => {});
    });

    scrollToResults();
  }

  function renderBriefAIResult(data) {
    const section = $("resultsSection");
    const container = $("resultsContainer");
    if (!section || !container) return;

    section.style.display = "block";

    const summary = safeTrim(data.summary || "");
    const bullets = Array.isArray(data.bullets) ? data.bullets : [];

    const bulletsHtml = bullets.map((b) => `<li>${escapeHtml(b)}</li>`).join("");

    container.innerHTML = `
      <div class="results-header">
        <div class="results-title">${escapeHtml(MODULE_TITLES.briefai)}</div>
        <div class="results-subtitle">Resumo em formato executivo.</div>
      </div>

      <div class="results-card">
        <div class="result-text">${escapeHtml(summary || "Sem resumo retornado.")}</div>

        ${
          bullets.length
            ? `<div class="result-bullets">
                <div class="bullets-title">Pontos principais</div>
                <ul>${bulletsHtml}</ul>
              </div>`
            : ""
        }

        <div class="result-actions">
          <button type="button" class="btn" id="copyBriefBtn">Copiar</button>
        </div>
      </div>
    `;

    $("copyBriefBtn")?.addEventListener("click", () => {
      const full = [summary, bullets.map((b) => `‚Ä¢ ${b}`).join("\n")].filter(Boolean).join("\n\n");
      navigator.clipboard.writeText(full).catch(() => {});
    });

    scrollToResults();
  }

  function formatDateTimeBR(isoOrText) {
    try {
      const d = new Date(isoOrText);
      if (Number.isNaN(d.getTime())) return String(isoOrText || "");
      return new Intl.DateTimeFormat("pt-BR", {
        timeZone: "America/Sao_Paulo",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      }).format(d);
    } catch {
      return String(isoOrText || "");
    }
  }

  function showError(err) {
    const section = $("resultsSection");
    const container = $("resultsContainer");
    if (!section || !container) return;

    const e = typeof err === "string" ? { message: err } : err || {};
    const code = e.code || "";
    const status = e.status || "";
    const details = e.details || {};

    let icon = "‚ùå";
    let title = "N√£o foi poss√≠vel gerar";
    let message = e.message || "Erro ao processar. Tente novamente.";
    let hint = "Confira sua conex√£o e tente novamente.";

    if (code === "RATE_LIMITED" || status === 429) {
      icon = "üõ°Ô∏è";
      title = "Limite di√°rio atingido";
      const limit = Number(details?.limit ?? 3);
      const resetAt = details?.resetAt;

      const resetText = resetAt ? `Voc√™ poder√° tentar novamente em ${formatDateTimeBR(resetAt)}.` : "Voc√™ poder√° tentar novamente amanh√£.";
      message = `Voc√™ pode usar at√© ${limit} vezes por dia por IP. ${resetText}`;
      hint = "Se voc√™ estiver em uma rede compartilhada, o limite pode valer para mais de uma pessoa.";
    }

    section.style.display = "block";
    container.innerHTML = `
      <div class="result-empty">
        <div class="result-icon">${icon}</div>
        <div style="font-weight:700;margin:6px 0 10px 0;">${escapeHtml(title)}</div>
        <p>${escapeHtml(message)}</p>
        <p style="opacity:.85;font-size:.95em;margin-top:10px;">${escapeHtml(hint)}</p>
      </div>
    `;
    scrollToResults();
  }

  function setBusy(isBusy) {
    const btn = $("processBtn");
    if (!btn) return;
    btn.disabled = !!isBusy;
    btn.classList.toggle("loading", !!isBusy);
    btn.textContent = isBusy ? "Gerando..." : PROCESS_BUTTON_LABELS[currentModule] || "‚ú® Gerar";
  }

  // ========= SUBMIT =========
  async function onGenerate() {
    setBusy(true);

    try {
      if (currentModule === "priorizai") {
        const tasks = getTasksFromUI();
        if (tasks.length < MIN_TASKS) {
          showError(`Preencha no m√≠nimo ${MIN_TASKS} tarefas completas antes de gerar.`);
          return;
        }

        const url = WORKER_BASE_URL + MODULE_ENDPOINTS.priorizai;
        const payload = { method: selectedMethod, tasks };

        const res = await callWorkerJson(url, payload);
        if (!res?.ok) throw new Error(res?.error || "Falha ao gerar prioriza√ß√£o.");

        renderPrioritizeResult(res.data || {});
        return;
      }

      if (currentModule === "calmai") {
        const text = safeTrim(getValue("calmaiText"));
        if (!text) {
          showError("Preencha o texto antes de gerar.");
          return;
        }

        const url = WORKER_BASE_URL + MODULE_ENDPOINTS.calmai;
        const payload = { text, tone: "neutro" };

        const res = await callWorkerJson(url, payload);
        if (!res?.ok) throw new Error(res?.error || "Falha ao gerar mensagem.");

        renderCalmAIResult(res.data || {});
        return;
      }

      if (currentModule === "briefai") {
        const text = safeTrim(getValue("briefaiText"));
        if (!text) {
          showError("Preencha o texto antes de gerar.");
          return;
        }

        const url = WORKER_BASE_URL + MODULE_ENDPOINTS.briefai;
        const payload = { text, style: "executivo" };

        const res = await callWorkerJson(url, payload);
        if (!res?.ok) throw new Error(res?.error || "Falha ao gerar resumo.");

        renderBriefAIResult(res.data || {});
        return;
      }

      showError("M√≥dulo inv√°lido.");
    } catch (err) {
      showError(err);
    } finally {
      setBusy(false);
    }
  }

  // ========= INIT =========
  function initProcessButton() {
    const btn = $("processBtn");
    if (!btn) return;
    btn.addEventListener("click", onGenerate);
    moveProcessButtonToModule(currentModule);
  }

  function initDefaults() {
    for (let i = 0; i < MIN_TASKS; i++) addTaskRow();
    switchModule("priorizai");
  }

  document.addEventListener("DOMContentLoaded", () => {
    initModuleTabs();
    initMethodCards();
    initTaskControls();
    initProcessButton();
    initDefaults();
  });
})();
